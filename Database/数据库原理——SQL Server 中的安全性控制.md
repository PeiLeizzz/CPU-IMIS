---
title: 数据库原理——SQL Server 中的安全性控制
date: 2020-06-04 15:00:10
tags: 
- Database
- SQL
categories:
- Database
toc: true
reward: true
---


<!-- more -->

## 关于 `SQL Server` 安全性控制的几个重要概念

### 安全模型的三个实体

实体|定义
:-:|:-:
Principal(实体)|一个**安全性主体**就是一个实体，比如**一个用户**
Securable(安全对象)|安全对象是**数据、项目、元数据**
Permission(权限)|权限**是作用在安全主体上**，**授予或拒绝**安全实体对安全对象是否有访问权限

`SQL Server`中使用**安全主体**和**安全对象**管理安全。安全主体在 3 个级别上管理：`Windows`、`SQL Server` 和数据库。安全主体的级别决定了安全主体的影响范围。通常 `Windows`、`SQL Server` 级别的安全主体具有**实例级**的范围，而数据级别的主体其影响范围是**特别的数据库**。

- **服务器级别的安全性**

  建立在控制服务器登录和密码的基础上

- **数据库级别的安全性**

  数据库的拥有者可以访问该数据库的对象，同时也可以授权给其他用户

- **数据库对象级别的安全性**

  数据库对象的安全性是检查用户权限的**最后一个安全等级**。创建数据库对象的时候，`SQL Server` 自动将该数据库对象的拥有权赋予该对象的所有者。（**应该修改**）

### 登录名（服务器登录名）

登录名的作用是**有权限登录到 `SQL Server` 服务器中**，但是，请注意，此时登陆成功后**仍然不能访问其中的数据库**，是**服务器级**的主体。（但是权限也可以授予登录名）

- 可以使用**域账户**创建域登录
- 也可以通过指定**唯一的登录 ID 和密码**来创建 `SQL Server` 登录
- 默认的登录包括**本地管理组员、本地管理员、sa、Network 和 SYSTEM 登录**

通过**使用 `sp_addlogin` 系统存储过程**创建一个新的 `SQL Server` 登录名：

例：`EXEC SP_ADDLOGIN 'su', '123', 'DBS'` 默认数据库为 `DBS`

**删除由 `sp_addlogin` 添加的 `SQL Server` 登录名：**

例：`EXEC SP_DROPLOGIN 'su'`

### 用户名（数据库用户）

用户名的作用是**访问 `SQL Server` 服务器中具体的数据库**，较登录名而言**更为具体**，即**真正有权限去访问数据**的是**用户名**。**数据库用户**是**数据库级**的主体，**是登录名在数据库中的映射**，可以在数据库中**直接执行操作和活动**。在 `SQL Server` 系统中，数据库用户**不能直接**拥有表、视图等**数据库对象**，而是通过**架构**拥有这些对象。

> 补充概念：
>
> **数据库级别设置：**
>
> **服务器级 -> 数据库级 -> 架构级 -> 数据对象级**，比如说：`Server.DataBase1.dbo.Table1`，这里的意思就是 `Table1` 这个表属于 `dbo` 这个**架构**，`dbo` 这个架构属于 `DataBase1` 这个数据库，`DataBase1` 这个数据库属于 `Server` 这个服务器。
>
> **架构**：
>
> 架构其实就是一个**容器**，好像就是面向对象里面的**命名空间，用户通过架构访问数据库对象**，**一个用户可以拥有多个架构，但是不能对没有拥有的架构进行操作。**

使用数据库用户账户可以**限制访问数据库的范围**，默认的数据库有：**dbo 用户、guest 用户、sys 用户等**

**创建数据库用户**：

- 通过**使用`sp_grantdbaccess`系统存储过程**为登录名创建数据库用户

  `EXEC SP_GRANTDBACCESS <login_name> <name_in_db>`

  注意：`<name_in_db>` 默认值为 `NULL`， **如果不指定，则使用 `<login_name>`**

  例：`EXEC SP_GRANTDBACCESS su` 将登录名`su`**作为数据库用户**进行添加。

  > **数据库用户是连接到数据库时的登录名的标识。 数据库用户可以使用与登录名相同的名称，但这不是必需的。**

- 通过使用 `create user` 语句为登录名创建数据库用户

  `CREATE USER <name_in_db> FOR LOGIN <login_name>`

**删除数据库用户**：

- `EXEC SP_REVOKEDBACCESS <name_in_db>`
- `FROP USER <name_in_db>`

### 服务器角色

服务器角色具有**授权服务器管理的功能**。服务器角色应用于**服务器级别**，并且需要**预定义**，是一组**固定的**服务器用户，默认有 9 组，这些角色是用于对其他**主体**进行分组的安全主体。 **服务器级角色的权限作用域为服务器范围。**

- 登录名**一定属于某些角色**，默认为 **`public`**
- 服务器角色**不容许更改**
- 登录后也不一定有权限操作数据库

**查看预定义服务器角色的内容**：

`EXEC SP_HELPSRVROLE`

**使用系统存储过程 `sp_addsrvrolemember` 增加登录名到服务器角色**：

例：`EXEC SP_ADDSRVROLEMEMBER 'su', 'sysadmin'`

**从 `sysadmin` 服务器角色中删除登录 `su`**：

例：`EXEC SP_DROPSRVROLEMENBER 'su', 'sysadmin'`

### 数据库角色

在数据库里，**角色代表一系列权限的集合**，如果将某个角色分配给某个用户，则这个用户就拥有了这一系列的权限。数据库角色可能涉及到**一个或多个**架构。

**使用 `SQL` 语句创建数据库角色**：

例：`CREATE ROLE R1`

**使用`SQL`语句创建由数据库用户拥有的数据库角色**：

创建用户 `BenMiller` 拥有的数据库角色 `buyers`：`CREATE ROLE buyers AUTHORIZATION BenMiller`

**使用 `SQL` 语句向数据库角色中添加成员或更改用户定义的数据库角色的名称**：

`ALTER ROLE <role_name> ADD MEMBER <name_in_db> | WITH NAME = <new_role_name>`

**使用系统存储过程 `SP_ADDROLEMEMBER` 语句为数据库角色添加数据库用户**：

`EXEC SP_ADDROLEMEMBER <role_name> <name_in_db>`

**删除数据库角色**：

**首先需要删除数据库角色中的所有数据库用户**，语句为：`EXEC SP_DROPROLEMEMBER <role_name> <name_in_db>`

**然后再删除数据库角色**，语句为：`DROP ROLE <role_name>`

> 一个数据库角色，是对不同架构里面数据对象的权限组织，也有可能涉及到多个架构，当某一个用户被转换成一种数据库角色的时候，假如**这个用户本身不拥有某一个架构而该数据库角色拥有**，那它当它对那个架构进行操作的时候就会出错。（**因为用户不能对没有拥有的架构进行操作**）

### 权限

权限是执行操作、访问数据库的通行证。在 `SQL Server` 中，不同的对象有着不同的权限，**用户和角色**的权限以记录的形式存储在**各个数据库的 `sysprotects` 系统表**中。**权限操作分为三种：`GRANT`，`ROVOKE`，`DENY`**

授权的对象可以是**登录名、数据库用户、数据库角色等**

**使用`SQL`语句进行授权**：

例：授予**登录名** `su` 在 `Student` 表上的 `SELECT` 和 `UPDATE` 权限

```sql
USE DBS
GO
GRANT SELECT, UPDATE
ON Student
TO su
GO
```

> 特别地，使用 `WITH GRANT OPTION` 指示该主体**还可以向其他主体授予所指定的权限**

**使用 `SQL` 语句进行权限的撤销**：

例：撤销登录名 `su` 在 `Student` 表上的 `UPDATE` 权限：

```sql
USE DBS
GO
REVOKE UPDATE
ON OBJECT::Student
FROM su CASCADE
```
::: tip
特别地，使用 `CASCADE` 指示当前正在撤消的权限**也将从其他被该主体授权的主体中撤消**

对授予 `WITH GRANT OPTION` 权限的权限执行级联撤消，**将同时撤消该权限的 `GRANT` 和 `REVOKE` 权限**
:::

## 几个概念之间的区别

### 登录名和用户名

- **映射关系不同**

  一个登录名可以和多个**不同库**下的用户做映射。

  **在同一个库下只能和一个用户做映射**，并且**一个用户名可以和多个登录名有映射关系**。

  > 在同一库下（数据库级），登录名和用户名是**一对一**，而在不同库下（服务器级），登录名和用户名是**一对多**

- **权限不同**

  **真正有权限的是用户名**，登录名只有登进数据库的功能，然后去找映射的用户名，这样就有了相应的权限。

> 登录名可以理解为进入整个大楼的钥匙，用户名可以理解为一个房间的钥匙。这里所说的大楼就是 `SQL Server` 服务器，而房间就是这个 `SQL Server` 服务器中的具体的数据库。

### 用户名和数据库角色

- 用户是具体到**某一个**账户个体，角色是**某一类**账户的集合。

- 比如说仓库管理员，这是一个角色，他们管理着仓库；但是可能公司里有好几个仓库管理员，他们是不同的用户；

- 在数据库里，**角色代表一系列权限的集合**，如果将某个角色分配给某个用户，则这个用户就拥有了这一系列的权限。
- **一个用户**对应**一个角色**，**一个角色**可以对应**多个用户**

- 这样做的好处是**不必为单个用户分配不同的权限**

  > 假如公司新招库管员一名，直接赋予他库管员的角色，他就有了管理仓库的一系列权限，如果这个人要调换到销售部门去，那么**直接给他换个角色就解决了权限的问题**。
  > 数据库下同理，有些用户只能查询某些表，而有些用户又只能执行 `SP` ，这种权限就需要角色来管理。

### 总结

**1. 一个数据库用户可以对应多个架构（架构是表容器）。架构里面包含的是数据库表。用户不可以操作不被他拥有的架构。**

**2. 一个数据库角色有可能涉及多个架构。数据库角色对应的是一系列权限。**

**3. 一个用户对应一个数据库角色。**

**4. 登录名与数据库用户在服务器级别是一对多的；在数据库级别是一对一的。**